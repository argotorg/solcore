import dispatch;

// PoC of start/init combo

// --------------------------------------------------------------------------------
contract StoreString {

  function setName(v: mstring) -> () {
    StorageType.store(0, v);
    let x : mstring = StorageType.sload(0);
     let ptr : word = Typedef.rep(x);
     let len : word;
     let n1 : word;
    assembly {
      len := sload(0)
      n1 := sload(1)
    }
    log1(len, 0x5e01);
    log1(n1, 0x5e02);

    assembly {
      len := mload(ptr)
      n1 := mload(add(ptr,32))
    }
    log1(len, 0x5e11);
    log1(n1, 0x5e12);
  }

  function getName() -> mstring {
    return StorageType.sload(0);
  }

  function getAnswer() -> uint256 {
    return uint256(42);
  }

  constructor(name: mstring) {
     setName(name);
  }
// Desugars to
/*

  function copy_arguments_for_constructor() -> (mstring)  {
    let res : mstring;
    let programSize : word;
    let argSize : word;
    let memoryDataOffset : word;

    assembly {
      programSize := datasize("StoreStringDeploy")
      argSize := sub(codesize(), programSize)
      memoryDataOffset := mload(64)
      mstore(64, add(memoryDataOffset, argSize))
      codecopy(memoryDataOffset, programSize, argSize)
    }

    let source : memory(bytes) = memory(memoryDataOffset);
    res = abi_decode(source, Proxy:Proxy( mstring ), Proxy:Proxy(MemoryWordReader));
    return res;

  }

  function init(name: mstring) -> () {
     let ptr : word = Typedef.rep(name);
     let len : word;
     let n1 : word;
     assembly {
       len := mload(ptr)
       n1 := mload(add(ptr,32))
     }
     log1(len, 0xc001);
     log1(n1, 0xc002);
     Storable.store(storage(0), name);
  }

  function start() -> () {
    assembly { mstore(64, memoryguard(128)) }

    let t = copy_arguments_for_constructor();
    let fn = init;
    fn(t);

    assembly {
      let size := datasize("StoreString")
      codecopy(0, dataoffset("StoreString"), datasize("StoreString"))
      return(0, size)
    }
    return ();
  }
  function main() -> mstring {
    return getName();
  }
*/
}
